name: FacebookTool

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup SSH
        run: |
          mkdir -p "$RUNNER_TEMP/ssh"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > "$RUNNER_TEMP/ssh/id_rsa"
          chmod 600 "$RUNNER_TEMP/ssh/id_rsa"
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> "$RUNNER_TEMP/ssh/known_hosts"

      - name: Test SSH
        run: |
          ssh -i "$RUNNER_TEMP/ssh/id_rsa" \
          -o UserKnownHostsFile="$RUNNER_TEMP/ssh/known_hosts" \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "echo CONNECTED"

      - name: Deploy
        run: |
          ssh -i "$RUNNER_TEMP/ssh/id_rsa" \
          -o UserKnownHostsFile="$RUNNER_TEMP/ssh/known_hosts" \
          ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "cd /var/www/html && \
           cp .env .env.backup && \
           git pull origin main && \
           mv .env.backup .env && \
           php artisan config:clear && \
           php artisan cache:clear && \
           php artisan view:clear && \
           echo DEPLOYED"
